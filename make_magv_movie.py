import numpy as np
import matplotlib.pyplot as plt
import h5py
from general_functions import *
from sliceplot import *

helio_idxpts = np.array([ -4.72848163e+00,  -4.70505681e+00,  -4.68163141e+00,  -4.65820658e+00,
  -4.63478176e+00, -4.61135722e+00, -4.58793240e+00, -4.56450699e+00,
  -4.54108217e+00, -4.51765734e+00, -4.49423252e+00, -4.47080798e+00,
  -4.44738258e+00, -4.42395776e+00, -4.40053293e+00, -4.37710811e+00,
  -4.35368328e+00, -4.33025817e+00, -4.30683334e+00, -4.28340852e+00,
  -4.25998370e+00, -4.23655858e+00, -4.21313376e+00, -4.18970893e+00,
  -4.16628411e+00, -4.14285928e+00, -4.11943417e+00, -4.09600935e+00,
  -4.07258452e+00, -4.04915970e+00, -4.02573487e+00, -4.00230976e+00,
  -3.97888493e+00, -3.95545982e+00, -3.93203528e+00, -3.90861046e+00,
  -3.88518535e+00, -3.86176052e+00, -3.83833541e+00, -3.81491058e+00,
  -3.79148605e+00, -3.76806093e+00, -3.74463611e+00, -3.72121100e+00,
  -3.69778617e+00, -3.67436135e+00, -3.65093681e+00, -3.62751170e+00,
  -3.60408658e+00, -3.58066176e+00, -3.55723693e+00, -3.53381211e+00,
  -3.51038728e+00, -3.48696217e+00, -3.46353735e+00, -3.44011252e+00,
  -3.41668770e+00, -3.39326287e+00, -3.36983776e+00, -3.34641293e+00,
  -3.32298811e+00, -3.29956328e+00, -3.27613817e+00, -3.25271335e+00,
  -3.22928852e+00, -3.20586370e+00, -3.18243887e+00, -3.15901376e+00,
  -3.13558893e+00, -3.11216411e+00, -3.08873928e+00, -3.06531446e+00,
  -3.04188935e+00, -3.01846423e+00, -2.99503941e+00, -2.97161487e+00,
  -2.94819005e+00, -2.92476493e+00, -2.90133982e+00, -2.87791500e+00,
  -2.85449017e+00, -2.83106563e+00, -2.80764052e+00, -2.78421541e+00,
  -2.76079058e+00, -2.73736576e+00, -2.71394093e+00, -2.69051611e+00,
  -2.66709100e+00, -2.64366617e+00, -2.62024135e+00, -2.59681623e+00,
  -2.57339170e+00, -2.54996687e+00, -2.52654176e+00, -2.50311693e+00,
  -2.47969182e+00, -2.45626700e+00, -2.43284246e+00, -2.40941735e+00,
  -2.38599252e+00, -2.36256741e+00, -2.33914273e+00, -2.31571790e+00,
  -2.29229279e+00, -2.26886811e+00, -2.24544300e+00, -2.22201817e+00,
  -2.19859349e+00, -2.17516838e+00, -2.15174355e+00, -2.12831858e+00,
  -2.10489376e+00, -2.08146893e+00, -2.05804397e+00, -2.03461914e+00,
  -2.01119417e+00, -1.98776935e+00, -1.96434452e+00, -1.94091955e+00,
  -1.91749473e+00, -1.89406962e+00, -1.87064493e+00, -1.84722011e+00,
  -1.82379500e+00, -1.80037032e+00, -1.77694520e+00, -1.75352038e+00,
  -1.73009570e+00, -1.70667058e+00, -1.68324576e+00, -1.65982079e+00,
  -1.63639597e+00, -1.61297114e+00, -1.58954617e+00, -1.56612135e+00,
  -1.54269623e+00, -1.51927155e+00, -1.49584673e+00, -1.47242162e+00,
  -1.44899693e+00, -1.42557182e+00, -1.40214700e+00, -1.37872232e+00,
  -1.35529720e+00, -1.33187238e+00, -1.30844741e+00, -1.28502258e+00,
  -1.26159776e+00, -1.23817279e+00, -1.21474797e+00, -1.19132293e+00,
  -1.16789817e+00, -1.14447335e+00, -1.12104831e+00, -1.09762355e+00,
  -1.07419851e+00, -1.05077369e+00, -1.02734894e+00, -1.00392389e+00,
  -9.80499070e-01, -9.57074029e-01, -9.33649276e-01, -9.10224451e-01,
  -8.86799410e-01, -8.63374657e-01, -8.39949616e-01, -8.16524791e-01,
  -7.93100039e-01, -7.69674998e-01, -7.46250173e-01, -7.22825132e-01,
  -6.99400379e-01, -6.75975554e-01, -6.52550513e-01, -6.29125761e-01,
  -6.05700720e-01, -5.82275895e-01, -5.58851106e-01, -5.35426065e-01,
  -5.12001276e-01, -4.88576235e-01, -4.65151698e-01, -4.41726406e-01,
  -4.18301617e-01, -3.94876828e-01, -3.71452039e-01, -3.48027250e-01,
  -3.24601957e-01, -3.01177168e-01, -2.77752379e-01, -2.54327591e-01,
  -2.30902802e-01, -2.07477491e-01, -1.84052702e-01, -1.60627913e-01,
  -1.37203133e-01, -1.13778344e-01, -9.03530425e-02, -6.69282581e-02,
  -4.35034693e-02, -2.00786827e-02,  3.34610644e-03,  2.67714059e-02,
   5.01961947e-02,  7.36209836e-02,  9.70457724e-02,  1.20470561e-01,
   1.43895854e-01,  1.67320643e-01,  1.90745432e-01,  2.14170221e-01,
   2.37595010e-01,  2.61020303e-01,  2.84445091e-01,  3.07869898e-01,
   3.31294687e-01,  3.54719476e-01,  3.78144769e-01,  4.01569558e-01,
   4.24994347e-01,  4.48419135e-01,  4.71843924e-01,  4.95269217e-01,
   5.18694006e-01,  5.42118795e-01,  5.65543584e-01,  5.88968373e-01,
   6.12393630e-01,  6.35818454e-01,  6.59243207e-01,  6.82668032e-01,
   7.06092785e-01,  7.29518114e-01,  7.52942939e-01,  7.76367692e-01,
   7.99792444e-01,  8.23217269e-01,  8.46642598e-01,  8.70067351e-01,
   8.93492176e-01,  9.16916929e-01,  9.40341754e-01,  9.63767011e-01,
   9.87191835e-01,  1.01061659e+00,  1.03404141e+00,  1.05746617e+00,
   1.08089149e+00,  1.10431625e+00,  1.12774107e+00,  1.15116583e+00,
   1.17459065e+00,  1.19801591e+00,  1.22144073e+00,  1.24486556e+00,
   1.26829024e+00,  1.29171506e+00,  1.31514032e+00,  1.33856514e+00,
   1.36198997e+00,  1.38541479e+00,  1.40883948e+00,  1.43226488e+00,
   1.45568956e+00,  1.47911438e+00,  1.50253921e+00,  1.52596403e+00,
   1.54938929e+00,  1.57281411e+00,  1.59623879e+00,  1.61966362e+00,
   1.64308844e+00,  1.66651370e+00,  1.68993853e+00,  1.71336335e+00,
   1.73678803e+00,  1.76021286e+00,  1.78363811e+00,  1.80706294e+00,
   1.83048776e+00,  1.85391259e+00,  1.87733727e+00,  1.90076267e+00,
   1.92418735e+00,  1.94761218e+00,  1.97103700e+00,  1.99446182e+00,
   2.01788708e+00,  2.04131191e+00,  2.06473673e+00,  2.08816141e+00,
   2.11158624e+00,  2.13501149e+00,  2.15843632e+00,  2.18186114e+00,
   2.20528597e+00,  2.22871065e+00,  2.25213605e+00,  2.27556073e+00,
   2.29898556e+00,  2.32241038e+00,  2.34583521e+00,  2.36926046e+00,
   2.39268529e+00,  2.41610997e+00,  2.43953494e+00,  2.46295947e+00,
   2.48638488e+00,  2.50980970e+00,  2.53323452e+00,  2.55665935e+00,
   2.58008417e+00,  2.60350929e+00,  2.62693411e+00,  2.65035894e+00,
   2.67378376e+00,  2.69720859e+00,  2.72063370e+00,  2.74405852e+00,
   2.76748335e+00,  2.79090817e+00,  2.81433300e+00,  2.83775811e+00,
   2.86118294e+00,  2.88460776e+00,  2.90803259e+00,  2.93145741e+00,
   2.95488281e+00,  2.97830735e+00,  3.00173217e+00,  3.02515700e+00,
   3.04858182e+00,  3.07200722e+00,  3.09543205e+00,  3.11885659e+00,
   3.14228141e+00,  3.16570624e+00,  3.18913164e+00,  3.21255646e+00,
   3.23598129e+00,  3.25940582e+00,  3.28283065e+00,  3.30625605e+00,
   3.32968087e+00,  3.35310570e+00,  3.37653052e+00,  3.39995535e+00,
   3.42338046e+00,  3.44680529e+00,  3.47023011e+00,  3.49365494e+00,
   3.51707976e+00,  3.54050487e+00,  3.56392970e+00,  3.58735452e+00,
   3.61077935e+00,  3.63420417e+00,  3.65762929e+00,  3.68105411e+00,
   3.70447894e+00,  3.72790376e+00,  3.75132859e+00,  3.77475399e+00,
   3.79817852e+00,  3.82160306e+00,  3.84502817e+00,  3.86845357e+00,
   3.89187782e+00,  3.91530322e+00,  3.93872747e+00,  3.96215259e+00,
   3.98557799e+00,  4.00900224e+00,  4.03242764e+00,  4.05585189e+00,
   4.07927700e+00,  4.10270240e+00,  4.12612665e+00,  4.14955205e+00,
   4.17297630e+00,  4.19640170e+00,  4.21982681e+00,  4.24325106e+00,
   4.26667646e+00,  4.29010071e+00,  4.31352611e+00,  4.33695122e+00,
   4.36037547e+00,  4.38380087e+00,  4.40722512e+00,  4.43065052e+00,
   4.45407592e+00,  4.47750017e+00,  4.50092529e+00,  4.52434953e+00,
   4.54777494e+00,  4.57120034e+00,  4.59462459e+00,  4.61804970e+00,
   4.64147395e+00,  4.66489935e+00,  4.68832475e+00,  4.71174900e+00,
   4.73517440e+00,  4.75859865e+00,  4.78202376e+00,  4.80544916e+00,
   4.82887341e+00,  4.85229881e+00])

def zi_finalize_plot(plot, z,orbit=None, fname='Output/test.pdf'):
    plot['figure'].set_size_inches(10,5)
    ax_labels = ['X','Y']
    mars_frac = np.real(np.sqrt(1-z**2))
    for ax_i, ax in enumerate(plot['axes']):
        ax.set_aspect('equal')
        circle = plt.Circle((0, 0), 1*mars_frac, color='k')
        ax.add_artist(circle)
        if orbit is not None: add_orbit(ax,ax_i, orbit)
        ax.set_xlabel('$\mathrm{'+ax_labels[0]+'} \;(R_M)$')
        ax.set_ylabel('$\mathrm{'+ax_labels[1]+'} \;(R_M)$')
    
    plot['axes'][0].set_title('$B_X$')
    plot['axes'][1].set_title('$B_Y$')
    plot['axes'][2].set_title('$\mathrm{Z=' +'{0:0.02}'.format(z)+'}\;(R_M)$')
    plt.tight_layout()
    print 'Saving: {0}'.format(fname)
    plt.savefig(fname, dpi=300)
    plt.close()


def make_plots_onax(infile, oprefix):
    ds = load_data(infile, fields=['magnetic_field_x', 'magnetic_field_y'], vec_field=False)

    print ds['z'][0,0,:]
    for idx in range(0, ds['x'].shape[2],1):
        plot = {}
        f, axes = plt.subplots(1,3)
        plot['figure'] = f
        plot['axes'] = axes

        
        for ax_i, v in enumerate(['x', 'y']):
            field = 'magnetic_field_{0}'.format(v)
            
            slc = slice_data(ds, 2, field, regrid_data=False, vec_field=False, idx=idx)
            plot_data(plot, slc, ax_i, vec_field=False, field=field,
		      logscale=False, zlim=(-30,30), cbar=False, diverge_cmap=True)
            
        ax_i = 2
        field = 'magnetic_field'
            
        slc = slice_data(ds, 2, field, regrid_data=False, vec_field=True, idx=idx)
        plot_data(plot, slc, ax_i, vec_field=True, field=field)
        
        z =ds['z'][0,0,idx]
        zi_finalize_plot(plot,
                         z=z,
                         fname='Output/zi_slices/{0}_zi-{1:03d}.png'.format(oprefix, idx))
    
def make_plots_offax(infile, oprefix):
    ds = load_data(infile, fields=['magnetic_field_x', 'magnetic_field_y'], vec_field=False)
    
    for idx, z in enumerate(helio_idxpts):
        if idx < 300: continue
        plot = {}
        f, axes = plt.subplots(1,3)
        plot['figure'] = f
        plot['axes'] = axes

        slc = slice_data(ds, 2, field='magnetic_field_x', regrid_data=True, vec_field=False,
                         center=[0,0,z], extra_fields = ['magnetic_field_y'])
        
        for ax_i, v in enumerate(['x', 'y']):
            field = 'magnetic_field_{0}'.format(v)
            slc_temp = (slc[0], slc[1], slc[2][field])
            plot_data(plot, slc_temp, ax_i, vec_field=False, field=field,
		      logscale=False, zlim=(-30,30), cbar=False, diverge_cmap=True)
            
        ax_i = 2
        field = 'magnetic_field'
        slc_temp = (slc[0], slc[1], [slc[2]['magnetic_field_x'],slc[2]['magnetic_field_y']])
        
        plot_data(plot, slc_temp, ax_i, vec_field=True, field=field)
        
        #z =ds['z'][0,0,idx]
        zi_finalize_plot(plot,
                         z=z,
                         fname='Output/zi_slices/{0}_zi-{1:03d}.png'.format(oprefix, idx))

def main(argv):
    try:
        opts, args = getopt.getopt(argv,"i:",["infile="])
    except getopt.GetoptError:
        return
    
    infile, field, orbit, test = None, None, None, False
    for opt, arg in opts:
        if opt in ("-i", "--infile"):
            infile = arg
    
    oprefix = 'slice_magv_bats_1' 
    if 'Heliosares' in infile: make_plots_onax(infile, oprefix)
    else: make_plots_offax(infile, oprefix)
    
    
    
if __name__ == '__main__':
    main(sys.argv[1:])

